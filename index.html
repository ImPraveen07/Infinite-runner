<!DOCTYPE html>
<html>
<head>
    <title>Naruto Runner - Optimized</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; overflow: hidden; background-color: #87ceeb; touch-action: none; font-family: 'Arial', sans-serif; }
        /* Loader Styles */
        #loading-screen {
            position: fixed; inset: 0; background: #000; color: white;
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000;
        }
        .loader-bar { width: 200px; height: 10px; background: #333; border-radius: 5px; margin-top: 20px; overflow: hidden; }
        #progress { width: 0%; height: 100%; background: #ff4444; transition: width 0.3s; }
        
        /* Game UI */
        #login-screen, #start-screen {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 200; color: white; text-align: center;
        }
        #start-screen { background: rgba(0,0,0,0.4); display: none; }
        #ui { position: fixed; top: 20px; left: 20px; color: white; text-shadow: 2px 2px #000; z-index: 10; font-size: 28px; font-weight: bold; display: none; }
        #fever-ui { position: fixed; top: 70px; left: 20px; color: #ffff00; font-size: 24px; font-weight: bold; display: none; text-shadow: 2px 2px #000; z-index: 10; align-items: center; gap: 10px; }
        #msg { position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%); color: #ff4444; font-size: 50px; font-weight: bold; display: none; text-shadow: 3px 3px #000; z-index: 100; }
        input { padding: 12px; margin: 10px; border-radius: 5px; border: none; }
        button { padding: 12px 25px; background: #ff4444; color: white; border: none; cursor: pointer; border-radius: 5px; font-weight: bold; }
    </style>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js"
        }
    }
    </script>
</head>
<body>

    <div id="loading-screen">
        <h1>LOADING JUTSU...</h1>
        <div class="loader-bar"><div id="progress"></div></div>
    </div>

    <div id="login-screen" style="display:none;">
        <h1>NARUTO RUNNER</h1>
        <input type="text" id="username" placeholder="Username">
        <input type="password" id="pass" placeholder="Password">
        <button id="login-btn">ENTER GAME</button>
    </div>

    <div id="start-screen">
        <h2 style="font-size: 40px;">TAP TO START</h2>
    </div>

    <div id="ui">SCORE: <span id="score">0</span></div>
    <div id="fever-ui">GOLD RUSH</div>
    <div id="msg">WASTED</div>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // --- GAME CONFIG ---
        const CONFIG = { 
            laneWidth: 4.8, startSpeed: 1.0, maxSpeed: 7.8, 
            jumpForce: 0.52, gravity: 0.03, coinScale: 8.0,
            WORLD_END_X: -850, startPosX: -135
        };

        let scene, camera, renderer, char, mixer, clock = new THREE.Clock();
        let isReady = false, gameStarted = false, isGameOver = false, score = 0;
        let coins = [], coinPool = [], collidableObjects = [];
        let currentLane = 0, verticalVelocity = 0, isJumping = false;
        let lastSpawnX = CONFIG.startPosX - 50;

        // --- LOADING SYSTEM ---
        const manager = new THREE.LoadingManager();
        const loader = new GLTFLoader(manager);

        manager.onProgress = (url, loaded, total) => {
            document.getElementById('progress').style.width = (loaded / total * 100) + '%';
        };

        manager.onLoad = () => {
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('login-screen').style.display = 'flex';
            isReady = true;
        };

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb);
            
            // LAG FIX 1: Fog hides far objects so GPU doesn't work too hard
            scene.fog = new THREE.Fog(0x87ceeb, 50, 350);

            camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // Limit pixel ratio for performance
            document.body.appendChild(renderer.domElement);

            scene.add(new THREE.AmbientLight(0xffffff, 3));
            
            // ONE-TIME ASSET LOADING
            loader.load('subway_surfers_maps.glb', (gltf) => {
                scene.add(gltf.scene);
                gltf.scene.traverse(c => { if(c.isMesh) collidableObjects.push(c); });
            });

            loader.load('naruto_uzumaki_running_animation.glb', (gltf) => {
                char = gltf.scene;
                char.scale.set(1.5, 1.5, 1.5);
                char.position.set(CONFIG.startPosX, 0.2, -53);
                scene.add(char);
                mixer = new THREE.AnimationMixer(char);
                mixer.clipAction(gltf.animations[0]).play();
            });

            loader.load('subway_surfers_coin.glb', (gltf) => {
                // Pre-create 50 coins and hide them (Object Pooling)
                for(let i=0; i<50; i++) {
                    let c = gltf.scene.clone();
                    c.scale.set(CONFIG.coinScale, CONFIG.coinScale, CONFIG.coinScale);
                    c.visible = false;
                    scene.add(c);
                    coinPool.push(c);
                }
            });

            animate();
        }

        // LAG FIX 2: Object Pooling (Reuse coins instead of creating them)
        function spawnCoin(x, y, lane) {
            let coin = coinPool.find(c => !c.visible);
            if (!coin) return;

            const z = -53 + (lane * CONFIG.laneWidth);
            coin.position.set(x, y, z);
            coin.visible = true;
            coin.userData.isCollected = false;
            coins.push(coin);
        }

        function spawnPattern() {
            const lane = Math.floor(Math.random() * 3) - 1;
            for(let i=0; i<5; i++) {
                spawnCoin(lastSpawnX - (i * 15), 3, lane);
            }
            lastSpawnX -= 150;
        }

        function animate() {
            requestAnimationFrame(animate);
            if (!isReady || !gameStarted || isGameOver) {
                if(isReady) renderer.render(scene, camera);
                return;
            }

            const delta = clock.getDelta();
            score += delta * 50;
            document.getElementById('score').innerText = Math.floor(score);

            // Movement Logic
            char.position.x -= CONFIG.startSpeed;
            if (lastSpawnX > char.position.x - 400) spawnPattern();

            // LAG FIX 3: Distance Culling (Disable coins far away)
            for (let i = coins.length - 1; i >= 0; i--) {
                let c = coins[i];
                let dist = Math.abs(c.position.x - char.position.x);

                if (dist > 300) {
                    c.visible = false; // Tell GPU to ignore
                    coins.splice(i, 1);
                    continue;
                }

                if (!c.userData.isCollected) {
                    c.rotation.y += 0.1;
                    if (char.position.distanceTo(c.position) < 4) {
                        c.userData.isCollected = true;
                        c.visible = false;
                    }
                }
            }

            // World Reset (Looping)
            if (char.position.x < CONFIG.WORLD_END_X) {
                char.position.x = CONFIG.startPosX;
                lastSpawnX = CONFIG.startPosX - 50;
            }

            // Camera follow
            camera.position.set(char.position.x + 20, char.position.y + 10, char.position.z);
            camera.lookAt(char.position.x - 10, char.position.y, char.position.z);

            if (mixer) mixer.update(delta * 2);
            renderer.render(scene, camera);
        }

        // UI Listeners
        document.getElementById('login-btn').onclick = () => {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('start-screen').style.display = 'flex';
        };

        window.addEventListener('touchstart', () => {
            if (!gameStarted && isReady) {
                gameStarted = true;
                document.getElementById('start-screen').style.display = 'none';
                document.getElementById('ui').style.display = 'block';
            }
        });

        init();
    </script>
</body>
</html>

