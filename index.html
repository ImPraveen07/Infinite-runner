<!DOCTYPE html>
<html>
<head>
    <title>Naruto Runner - Smooth Version</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; touch-action: none; font-family: sans-serif; }
        
        /* Loading Screen Style */
        #loading-screen {
            position: fixed; inset: 0; background: #000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 500; color: white;
        }
        #progress-bar-container { width: 200px; height: 10px; background: #333; border-radius: 5px; margin-top: 20px; }
        #progress-bar { width: 0%; height: 100%; background: #ff4444; border-radius: 5px; transition: width 0.3s; }

        #login-screen, #start-screen {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8);
            display: none; flex-direction: column; align-items: center; justify-content: center;
            z-index: 200; color: white; text-align: center;
        }
        #ui { position: fixed; top: 20px; left: 20px; color: white; text-shadow: 2px 2px #000; z-index: 10; font-size: 28px; font-weight: bold; display: none; }
        #msg { position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%); color: #ff4444; font-size: 50px; font-weight: bold; display: none; text-shadow: 3px 3px #000; z-index: 100; }
        input { padding: 12px; margin: 10px; border-radius: 5px; border: none; }
        button { padding: 12px 25px; background: #ff4444; color: white; border: none; cursor: pointer; border-radius: 5px; font-weight: bold; }
    </style>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
    </script>
</head>
<body>

    <div id="loading-screen">
        <h1>LOADING ASSETS...</h1>
        <div id="progress-bar-container"><div id="progress-bar"></div></div>
    </div>

    <div id="login-screen">
        <h1>NARUTO RUNNER</h1>
        <input type="text" id="username" placeholder="Username">
        <input type="password" id="pass" placeholder="Password">
        <button id="login-btn">ENTER GAME</button>
    </div>

    <div id="start-screen">
        <h2 style="font-size: 40px;">TAP TO START</h2>
        <p>Best Score: <span id="best-ui">0</span></p>
    </div>

    <div id="ui">SCORE: <span id="score">0</span></div>
    <div id="msg">WASTED</div>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        let scene, camera, renderer, char, mixer, clock = new THREE.Clock();
        let isReady = false, gameStarted = false, isGameOver = false, score = 0;
        let coins = [], coinTemplate = null, collidableObjects = [];
        let lastSpawnX = -150, currentSpeed = 1.0;
        const downRay = new THREE.Raycaster(), frontRay = new THREE.Raycaster();

        // 1. ASSET LOADING MANAGER
        const loadingManager = new THREE.LoadingManager();
        const progressBar = document.getElementById('progress-bar');

        loadingManager.onProgress = (url, itemsLoaded, itemsTotal) => {
            progressBar.style.width = (itemsLoaded / itemsTotal * 100) + '%';
        };

        loadingManager.onLoad = () => {
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('login-screen').style.display = 'flex';
        };

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb);
            
            // Performance Camera
            camera = new THREE.PerspectiveCamera(55, window.innerWidth / window.innerHeight, 0.1, 400);
            
            renderer = new THREE.WebGLRenderer({ antialias: false, powerPreference: "high-performance" });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(1); // Force standard resolution for speed
            document.body.appendChild(renderer.domElement);

            scene.add(new THREE.AmbientLight(0xffffff, 2.0));
            const sun = new THREE.DirectionalLight(0xffffff, 0.8);
            sun.position.set(10, 50, 10);
            scene.add(sun);

            const loader = new GLTFLoader(loadingManager);

            // Load Map
            loader.load('subway_surfers_maps.glb', (gltf) => {
                scene.add(gltf.scene);
                gltf.scene.traverse(c => {
                    if(c.isMesh) {
                        c.matrixAutoUpdate = false; 
                        c.updateMatrix();
                        collidableObjects.push(c);
                    }
                });
            });

            // Load Naruto
            loader.load('naruto_uzumaki_running_animation.glb', (gChar) => {
                char = gChar.scene;
                char.scale.set(1.5, 1.5, 1.5);
                char.position.set(-135, 0.2, -53);
                char.rotation.y = -Math.PI / 2;
                scene.add(char);
                mixer = new THREE.AnimationMixer(char);
                mixer.clipAction(gChar.animations[0]).play();
            });

            // Load Coin (with backup)
            loader.load('subway_surfers_coin.glb', (gCoin) => {
                coinTemplate = gCoin.scene;
            }, undefined, () => {
                const geo = new THREE.CylinderGeometry(0.5,0.5,0.1,8);
                const mat = new THREE.MeshBasicMaterial({color: 0xffff00});
                coinTemplate = new THREE.Mesh(geo, mat);
            });

            document.getElementById('login-btn').onclick = () => {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('start-screen').style.display = 'flex';
            };

            window.addEventListener('touchstart', () => {
                if(!gameStarted && char) {
                    gameStarted = true;
                    document.getElementById('start-screen').style.display = 'none';
                    document.getElementById('ui').style.display = 'block';
                    animate();
                }
            });
        }

        function animate() {
            if (isGameOver) return;
            requestAnimationFrame(animate);

            // DELTA TIME: Makes movement smooth even if FPS drops
            const delta = Math.min(clock.getDelta(), 0.1); 
            const frameFactor = delta * 60; // Normalize to 60fps

            score += 0.1 * frameFactor;
            document.getElementById('score').innerText = Math.floor(score);

            // Move Naruto based on Delta Time
            currentSpeed = Math.min(1.0 + (score * 0.0001), 5.0);
            char.position.x -= currentSpeed * frameFactor;

            // Spawn Logic
            if (lastSpawnX > char.position.x - 200) {
                if(coinTemplate) {
                    const coin = coinTemplate.clone();
                    coin.position.set(lastSpawnX, 2, -53);
                    scene.add(coin);
                    coins.push(coin);
                }
                lastSpawnX -= 50;
            }

            // Raycast Ground
            downRay.set(new THREE.Vector3(char.position.x, char.position.y + 2, char.position.z), new THREE.Vector3(0, -1, 0));
            const hits = downRay.intersectObjects(collidableObjects, true);
            if (hits.length > 0) char.position.y = hits[0].point.y;

            // Camera Follow
            camera.position.set(char.position.x + 20, char.position.y + 8, char.position.z);
            camera.lookAt(char.position.x - 10, char.position.y, char.position.z);

            if (mixer) mixer.update(delta);
            renderer.render(scene, camera);
        }

        init();
    </script>
</body>
</html>

