<!DOCTYPE html>
<html>
<head>
    <title>Naruto Runner - Extreme Optimization</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; touch-action: none; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* Preloader Styles */
        #loader-wrapper {
            position: fixed; inset: 0; background: #111;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 1000; transition: opacity 0.8s ease;
        }
        #progress-container { width: 250px; height: 6px; background: #333; border-radius: 10px; margin-top: 20px; overflow: hidden; }
        #progress-bar { width: 0%; height: 100%; background: #ff4444; box-shadow: 0 0 15px #ff4444; transition: width 0.3s; }
        .loading-text { color: white; font-size: 14px; letter-spacing: 3px; font-weight: bold; text-transform: uppercase; }

        /* UI Styles */
        #login-screen, #start-screen {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 200; color: white; text-align: center;
        }
        #start-screen { background: rgba(0,0,0,0.5); display: none; }
        #ui { position: fixed; top: 20px; left: 20px; color: white; text-shadow: 2px 2px #000; z-index: 10; font-size: 28px; font-weight: bold; display: none; }
        #fever-ui { position: fixed; top: 70px; left: 20px; color: #ffff00; font-size: 24px; font-weight: bold; display: none; z-index: 10; align-items: center; gap: 10px; }
        #leaderboard { position: fixed; top: 20px; right: 20px; color: gold; text-shadow: 1px 1px #000; z-index: 10; font-size: 14px; text-align: right; pointer-events: none; }
        
        input { padding: 12px; margin: 10px; border-radius: 8px; border: none; font-size: 16px; width: 200px; }
        button { padding: 12px 25px; background: #ff4444; color: white; border: none; font-size: 18px; font-weight: bold; cursor: pointer; border-radius: 8px; transition: 0.3s; }
        button:active { transform: scale(0.95); }
        #msg { position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%); color: #ff4444; font-size: 60px; font-weight: bold; display: none; text-shadow: 4px 4px #000; z-index: 100; }
    </style>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js"
        }
    }
    </script>
</head>
<body>

    <div id="loader-wrapper">
        <div class="loading-text">LOADING ASSETS</div>
        <div id="progress-container"><div id="progress-bar"></div></div>
        <p style="color: #666; font-size: 10px; margin-top: 10px;">OPTIMIZING FOR YOUR DEVICE</p>
    </div>

    <div id="login-screen">
        <h1 style="color: #ff4444; font-size: 40px;">NARUTO RUN</h1>
        <input type="text" id="username" placeholder="Username">
        <input type="password" id="pass" placeholder="Password">
        <button id="login-btn">ENTER GAME</button>
    </div>

    <div id="start-screen">
        <div id="score-stats" style="margin-bottom: 20px; font-size: 20px;">
            BEST: <span id="best-score-ui">0</span> | PREV: <span id="prev-score-ui">0</span>
        </div>
        <h2 style="font-size: 40px;">TAP TO RUN</h2>
    </div>

    <div id="ui">SCORE: <span id="score">0</span></div>
    <div id="fever-ui">GOLD RUSH ðŸ”¥</div>
    <div id="leaderboard">TOP PLAYERS<br><div id="high-scores-list"></div></div>
    <div id="msg">WASTED</div>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { initializeApp } from "firebase/app";
        import { getFirestore, collection, query, orderBy, limit, getDocs, doc, setDoc, getDoc } from "firebase/firestore";

        // --- SERVICE WORKER REGISTRATION (Cache Assets Locally) ---
        if ('serviceWorker' in navigator) {
            const swCode = `
                const CACHE_NAME = 'naruto-v1';
                const ASSETS = [
                    'subway_surfers_maps.glb',
                    'naruto_uzumaki_running_animation.glb',
                    'subway_surfers_coin.glb',
                    'subway-surfers-coin-collect.mp3',
                    'Subway-Surfers-Theme-Sound-Effect.mp3'
                ];
                self.addEventListener('install', e => e.waitUntil(caches.open(CACHE_NAME).then(c => c.addAll(ASSETS))));
                self.addEventListener('fetch', e => e.respondWith(caches.match(e.request).then(r => r || fetch(e.request))));
            `;
            const blob = new Blob([swCode], { type: 'application/javascript' });
            navigator.serviceWorker.register(URL.createObjectURL(blob));
        }

        // --- FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBUUd2oA6HMEpa7TqOwOiiUCKSugsLOrUY",
            authDomain: "game-e2f9a.firebaseapp.com",
            projectId: "game-e2f9a",
            storageBucket: "game-e2f9a.firebasestorage.app",
            messagingSenderId: "997350610258",
            appId: "1:997350610258:web:495b64bd803b12e3b1968b"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- GAME ENGINE VARIABLES ---
        let scene, camera, renderer, char, mixer, clock = new THREE.Clock();
        let isReady = false, isGameOver = false, gameStarted = false, score = 0;
        let listener, coinSound, bgMusic, currentUsername = "";
        let coins = [], coinTemplate = null, collidableObjects = [];
        let lastSpawnX = -150, currentSpeed = 1.0, currentLane = 0;
        let verticalVelocity = 0, isJumping = false, isRolling = false;

        const CONFIG = { 
            laneWidth: 4.8, startSpeed: 1.0, maxSpeed: 8.0, 
            jumpForce: 0.52, gravity: 0.025, rollDuration: 800,
            WORLD_END_X: -850, groundY: 0.2
        };

        const railPoints = [{ x: -131, z: -53.0 }, { x: -406, z: -53.4 }, { x: -506, z: -54.1 }, { x: -661, z: -55.4 }, { x: -861, z: -57.5 }];

        // --- INITIALIZATION ---
        init();

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb);
            camera = new THREE.PerspectiveCamera(55, window.innerWidth / window.innerHeight, 0.1, 2000);
            
            renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // Smooth performance
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.outputColorSpace = THREE.SRGBColorSpace;
            document.body.appendChild(renderer.domElement);

            // Lighting
            scene.add(new THREE.AmbientLight(0xffffff, 2.5));
            const sun = new THREE.DirectionalLight(0xffffff, 1.0);
            sun.position.set(5, 20, 10);
            scene.add(sun);

            // Loading Manager
            const manager = new THREE.LoadingManager();
            const pBar = document.getElementById('progress-bar');
            manager.onProgress = (url, loaded, total) => {
                pBar.style.width = (loaded / total * 100) + '%';
            };
            manager.onLoad = () => {
                isReady = true;
                document.getElementById('loader-wrapper').style.opacity = '0';
                setTimeout(() => document.getElementById('loader-wrapper').style.display = 'none', 800);
                checkPersistence();
            };

            const loader = new GLTFLoader(manager);
            const audioLoader = new THREE.AudioLoader(manager);

            // Load Models
            loader.load('subway_surfers_maps.glb', (gltf) => {
                scene.add(gltf.scene);
                gltf.scene.traverse(c => { if(c.isMesh) collidableObjects.push(c); });
            });

            loader.load('naruto_uzumaki_running_animation.glb', (gChar) => {
                char = gChar.scene;
                char.scale.set(1.5, 1.5, 1.5);
                char.position.set(-135, CONFIG.groundY, -53);
                char.rotation.y = -Math.PI/2;
                scene.add(char);
                mixer = new THREE.AnimationMixer(char);
                if(gChar.animations.length > 0) mixer.clipAction(gChar.animations[0]).play();
            });

            loader.load('subway_surfers_coin.glb', (gCoin) => {
                coinTemplate = gCoin.scene;
            });

            // Audio
            listener = new THREE.AudioListener();
            camera.add(listener);
            coinSound = new THREE.Audio(listener);
            bgMusic = new THREE.Audio(listener);
            audioLoader.load('subway-surfers-coin-collect.mp3', b => coinSound.setBuffer(b));
            audioLoader.load('Subway-Surfers-Theme-Sound-Effect.mp3', b => {
                bgMusic.setBuffer(b); bgMusic.setLoop(true); bgMusic.setVolume(0.4);
            });

            // Events
            document.getElementById('login-btn').onclick = login;
            window.addEventListener('touchstart', onTouch);
            window.addEventListener('resize', onWindowResize);
            animate();
        }

        // --- GAME LOGIC ---
        function getTrackZ(x) {
            for (let i = 0; i < railPoints.length - 1; i++) {
                let p1 = railPoints[i], p2 = railPoints[i+1];
                if (x <= p1.x && x >= p2.x) {
                    let r = (x - p1.x) / (p2.x - p1.x);
                    return p1.z + r * (p2.z - p1.z);
                }
            }
            return railPoints[railPoints.length-1].z;
        }

        function spawnCoins() {
            if(!coinTemplate) return;
            const lane = Math.floor(Math.random() * 3) - 1;
            for(let i=0; i<5; i++) {
                const c = coinTemplate.clone();
                const x = lastSpawnX - (i * 12);
                c.scale.set(8, 8, 8);
                c.position.set(x, 2.5, getTrackZ(x) + (lane * CONFIG.laneWidth));
                c.userData = { isCollected: false };
                scene.add(c);
                coins.push(c);
            }
            lastSpawnX -= 120;
        }

        function animate() {
            requestAnimationFrame(animate);
            if (!isReady || !gameStarted || isGameOver) {
                renderer.render(scene, camera);
                return;
            }

            const delta = clock.getDelta();
            
            // Speed & Score
            currentSpeed = Math.min(CONFIG.startSpeed + (score * 0.00005), CONFIG.maxSpeed);
            score += delta * 15;
            document.getElementById('score').innerText = Math.floor(score);

            char.position.x -= currentSpeed;
            if (lastSpawnX > char.position.x - 400) spawnCoins();

            // Lane interpolation
            const targetZ = getTrackZ(char.position.x) + (currentLane * CONFIG.laneWidth);
            char.position.z = THREE.MathUtils.lerp(char.position.z, targetZ, 0.15);

            // Physics (Jump/Roll)
            char.position.y += verticalVelocity;
            if (char.position.y > CONFIG.groundY) {
                verticalVelocity -= CONFIG.gravity;
            } else {
                char.position.y = CONFIG.groundY;
                verticalVelocity = 0;
                isJumping = false;
            }

            // Coin Collision
            for (let i = coins.length - 1; i >= 0; i--) {
                const c = coins[i];
                if (!c.userData.isCollected && char.position.distanceTo(c.position) < 4) {
                    c.userData.isCollected = true;
                    score += 50;
                    if (coinSound.isPlaying) coinSound.stop();
                    coinSound.play();
                }
                if (c.position.x > char.position.x + 50) {
                    scene.remove(c);
                    coins.splice(i, 1);
                } else if (c.userData.isCollected) {
                    c.position.y += 0.5;
                    c.scale.multiplyScalar(0.9);
                }
            }

            // Camera follow
            camera.position.set(char.position.x + 22, char.position.y + 8, char.position.z);
            camera.lookAt(char.position.x - 20, char.position.y + 2, char.position.z);

            if (mixer) mixer.update(delta * (currentSpeed * 1.5));
            renderer.render(scene, camera);
        }

        // --- INPUT & AUTH (Simplified for performance) ---
        let sX, sY;
        function onTouch(e) {
            if (!gameStarted && isReady && currentUsername) {
                gameStarted = true;
                document.getElementById('start-screen').style.display = 'none';
                document.getElementById('ui').style.display = 'block';
                bgMusic.play();
                return;
            }
            sX = e.touches[0].clientX; sY = e.touches[0].clientY;
            window.ontouchend = (em) => {
                let dx = sX - em.changedTouches[0].clientX, dy = sY - em.changedTouches[0].clientY;
                if (Math.abs(dx) > 30) {
                    if (dx > 30 && currentLane < 1) currentLane++;
                    if (dx < -30 && currentLane > -1) currentLane--;
                } else if (Math.abs(dy) > 30) {
                    if (dy > 30 && !isJumping) { verticalVelocity = CONFIG.jumpForce; isJumping = true; }
                }
                window.ontouchend = null;
            };
        }

        async function login() {
            const user = document.getElementById('username').value.trim();
            if (!user) return;
            currentUsername = user;
            localStorage.setItem('naruto_user', user);
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('start-screen').style.display = 'flex';
        }

        function checkPersistence() {
            const saved = localStorage.getItem('naruto_user');
            if (saved) {
                currentUsername = saved;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('start-screen').style.display = 'flex';
            }
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
    </script>
</body>
</html>

