<!DOCTYPE html>
<html>
<head>
    <title>Naruto Runner - Extreme Hard Mode</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; overflow: hidden; background-color: #87ceeb; touch-action: none; font-family: 'Arial', sans-serif; }
        
        #loader-wrapper {
            position: fixed; inset: 0; background: #000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 1000; transition: opacity 0.5s;
        }
        #progress-container { width: 200px; height: 10px; background: #333; border-radius: 5px; margin-top: 20px; overflow: hidden; }
        #progress-bar { width: 0%; height: 100%; background: #ff4444; transition: width 0.2s; }
        .loading-text { color: white; letter-spacing: 2px; font-weight: bold; }

        #login-screen, #start-screen {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 200; color: white; text-align: center;
        }
        #start-screen { background: rgba(0,0,0,0.5); display: none; }
        
        #top-nav { position: absolute; top: 10px; width: 100%; display: flex; flex-direction: column; align-items: center; z-index: 210; gap: 15px; }
        .change-btn { background: rgba(255,255,255,0.2); border: 1px solid white; color: white; padding: 5px 15px; border-radius: 20px; font-size: 14px; cursor: pointer; }
        
        #mode-selector { display: flex; background: rgba(0,0,0,0.6); border-radius: 25px; padding: 5px; border: 1px solid #fff; }
        .mode-btn { padding: 8px 20px; border-radius: 20px; border: none; cursor: pointer; font-weight: bold; color: white; background: transparent; transition: 0.3s; font-size: 12px; }
        .mode-btn.active { background: #ff4444; box-shadow: 0 0 10px #ff4444; }

        #teleport-timer {
            position: fixed; top: 80px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 0, 0, 0.9); color: white; padding: 8px 20px;
            border-radius: 10px; font-weight: bold; display: none; z-index: 100;
            border: 2px solid white;
        }

        #ui { position: fixed; top: 20px; left: 20px; color: white; text-shadow: 2px 2px #000; z-index: 10; font-size: 28px; font-weight: bold; display: none; }
        #fever-ui { position: fixed; top: 70px; left: 20px; color: #ffff00; font-size: 24px; font-weight: bold; display: none; text-shadow: 2px 2px #000; z-index: 10; align-items: center; gap: 10px; }
        #leaderboard { position: fixed; top: 20px; right: 20px; color: gold; text-shadow: 1px 1px #000; z-index: 10; font-size: 14px; text-align: right; pointer-events: none; }
        input { padding: 12px; margin: 10px; border-radius: 5px; border: none; font-size: 16px; color: #000; }
        button#login-btn { padding: 12px 25px; background: #ff4444; color: white; border: none; font-size: 18px; font-weight: bold; cursor: pointer; border-radius: 5px; }
        #msg { position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%); color: #ff4444; font-size: 50px; font-weight: bold; display: none; text-shadow: 3px 3px #000; z-index: 100; text-align: center; }
    </style>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js"
        }
    }
    </script>
</head>
<body>

    <div id="loader-wrapper">
        <div class="loading-text">LOADING ASSETS...</div>
        <div id="progress-container"><div id="progress-bar"></div></div>
    </div>

    <div id="teleport-timer">JUMP IN: <span id="tp-seconds">4.0</span>s</div>

    <div id="login-screen">
        <h1>NARUTO RUNNER</h1>
        <input type="text" id="username" placeholder="Username">
        <input type="password" id="pass" placeholder="Password">
        <button id="login-btn">ENTER GAME</button>
    </div>

    <div id="start-screen">
        <div id="top-nav">
            <button class="change-btn" id="change-name-btn">Change User: <span id="current-user-display"></span></button>
            <div id="mode-selector">
                <button id="easy-mode" class="mode-btn active">EASY</button>
                <button id="hard-mode" class="mode-btn">HARD (2x)</button>
            </div>
        </div>
        <div id="score-stats" style="margin-bottom: 20px; font-size: 20px;">
            BEST: <span id="best-score-ui">0</span> | PREV: <span id="prev-score-ui">0</span>
        </div>
        <h2 style="font-size: 40px; margin: 0;">TAP TO START</h2>
    </div>

    <div id="ui">SCORE: <span id="score">0</span></div>
    <div id="fever-ui">GOLD RUSH âœ¨</div>
    <div id="leaderboard">TOP 5 PLAYERS<br><div id="high-scores-list"></div></div>
    <div id="msg">WASTED</div>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { initializeApp } from "firebase/app";
        import { getFirestore, collection, query, orderBy, limit, getDocs, doc, setDoc, getDoc } from "firebase/firestore";

        const firebaseConfig = { apiKey: "AIzaSyBUUd2oA6HMEpa7TqOwOiiUCKSugsLOrUY", authDomain: "game-e2f9a.firebaseapp.com", projectId: "game-e2f9a", storageBucket: "game-e2f9a.firebasestorage.app", messagingSenderId: "997350610258", appId: "1:997350610258:web:495b64bd803b12e3b1968b" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let scene, camera, renderer, char, mixer, clock = new THREE.Clock();
        let isReady = false, isGameOver = false, gameStarted = false, score = 0;
        let listener, coinSound, bgMusic, userBest = 0, userPrev = 0, currentUsername = "";
        let coins = [], coinTemplate = null, collidableObjects = [];
        let lastSpawnX = -150, scoreTimer = 0;
        let gameDifficulty = "easy";
        
        // --- TELEPORT & DYNAMIC AURA SYSTEM ---
        let tpTimer = 4.0; 
        let isImmune = false;
        let auraTimeRemaining = 0;
        let auraMesh = null;
        let currentMaxAura = 0.8; // Starts at 0.8
        let lastAuraMilestone = 0;
        const MIN_AURA = 0.3;
        const tpRay = new THREE.Raycaster();

        let isFeverMode = false, feverEndTime = 0;
        const feverMilestones = [500, 10000, 25000, 50000];
        let triggeredMilestones = [];

        const CONFIG = { laneWidth: 4.8, startSpeed: 1.0, maxSpeed: 7.8, speedFactor: 0.00006, laneSnapSpeed: 0.15, startPosX: -135, groundY: 0.2, jumpForce: 0.52, gravity: 0.03, rollGravity: 0.18, rollDuration: 900, coinValue: 50, coinScale: 8.0, WORLD_END_X: -850 };
        const railPoints = [{ x: -131, z: -53.0 }, { x: -406, z: -53.4 }, { x: -506, z: -54.1 }, { x: -661, z: -55.4 }, { x: -861, z: -57.5 }];
        let currentSpeed = CONFIG.startSpeed, currentLane = 0, verticalVelocity = 0, isJumping = false, isRolling = false, rollStartTime = 0;
        const downRay = new THREE.Raycaster(), frontRay = new THREE.Raycaster();

        document.getElementById('easy-mode').onclick = (e) => { e.stopPropagation(); gameDifficulty = "easy"; updateModeUI(); };
        document.getElementById('hard-mode').onclick = (e) => { e.stopPropagation(); gameDifficulty = "hard"; updateModeUI(); };

        function updateModeUI() {
            document.getElementById('easy-mode').classList.toggle('active', gameDifficulty === 'easy');
            document.getElementById('hard-mode').classList.toggle('active', gameDifficulty === 'hard');
            document.getElementById('ui').style.color = (gameDifficulty === 'hard') ? '#ff4444' : 'white';
        }

        async function checkPersistence() {
            const saved = localStorage.getItem('naruto_user');
            if (saved) { currentUsername = saved; const userSnap = await getDoc(doc(db, "players", currentUsername)); if (userSnap.exists()) { userBest = userSnap.data().bestScore || 0; userPrev = userSnap.data().prevScore || 0; } enterGameUI(); }
        }

        function enterGameUI() { document.getElementById('login-screen').style.display = 'none'; document.getElementById('start-screen').style.display = 'flex'; document.getElementById('current-user-display').innerText = currentUsername; updateStatsUI(); fetchLeaderboard(); }

        function getTrackZ(x) {
            for (let i = 0; i < railPoints.length - 1; i++) {
                let p1 = railPoints[i], p2 = railPoints[i+1];
                if (x <= p1.x && x >= p2.x) { let r = (x - p1.x) / (p2.x - p1.x); return p1.z + r * (p2.z - p1.z); }
            }
            return railPoints[railPoints.length-1].z;
        }

        init();

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb);
            camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 5000);
            renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.outputColorSpace = THREE.SRGBColorSpace;
            document.body.appendChild(renderer.domElement);
            scene.add(new THREE.AmbientLight(0xffffff, 3.5));
            const sun = new THREE.DirectionalLight(0xffffff, 1.5); sun.position.set(10, 50, 10); scene.add(sun);

            const loadingManager = new THREE.LoadingManager();
            const pBar = document.getElementById('progress-bar');
            loadingManager.onProgress = (u, l, t) => pBar.style.width = (l/t*100)+'%';
            loadingManager.onLoad = () => { isReady = true; document.getElementById('loader-wrapper').style.opacity = '0'; setTimeout(()=>document.getElementById('loader-wrapper').style.display = 'none', 500); checkPersistence(); };

            const loader = new GLTFLoader(loadingManager);
            const audioLoader = new THREE.AudioLoader(loadingManager);

            loader.load('subway_surfers_maps.glb', (gltf) => { scene.add(gltf.scene); gltf.scene.traverse(c => { if(c.isMesh) collidableObjects.push(c); }); });
            loader.load('naruto_uzumaki_running_animation.glb', (gChar) => { 
                char = gChar.scene; 
                char.scale.set(1.5, 1.5, 1.5); 
                char.position.set(CONFIG.startPosX, CONFIG.groundY, -53); 
                char.rotation.set(0, -Math.PI / 2, 0); 
                scene.add(char); 

                // Setup Aura Mesh
                const auraGeo = new THREE.IcosahedronGeometry(1.4, 1);
                const auraMat = new THREE.MeshBasicMaterial({ color: 0x00ffff, transparent: true, opacity: 0.6, wireframe: true });
                auraMesh = new THREE.Mesh(auraGeo, auraMat);
                auraMesh.visible = false;
                char.add(auraMesh);
                auraMesh.position.y = 1.0;

                mixer = new THREE.AnimationMixer(char); 
                if(gChar.animations.length > 0) mixer.clipAction(gChar.animations[0]).play(); 
            });
            loader.load('subway_surfers_coin.glb', (gCoin) => { coinTemplate = gCoin.scene; });

            listener = new THREE.AudioListener(); camera.add(listener);
            coinSound = new THREE.Audio(listener); bgMusic = new THREE.Audio(listener);
            audioLoader.load('subway-surfers-coin-collect.mp3', (b) => { coinSound.setBuffer(b); coinSound.setVolume(0.4); });
            audioLoader.load('Subway-Surfers-Theme-Sound-Effect.mp3', (b) => { bgMusic.setBuffer(b); bgMusic.setLoop(true); bgMusic.setVolume(0.5); });

            document.getElementById('login-btn').onclick = login;
            document.getElementById('change-name-btn').onclick = () => { localStorage.removeItem('naruto_user'); location.reload(); };
            window.addEventListener('touchstart', onTouch);
            animate();
        }

        async function login() {
            const user = document.getElementById('username').value.trim(); const pass = document.getElementById('pass').value; if (!user) return alert("Enter username");
            const userRef = doc(db, "players", user); const userSnap = await getDoc(userRef);
            if (userSnap.exists()) { if (userSnap.data().password && userSnap.data().password !== pass) return alert("Incorrect password"); userBest = userSnap.data().bestScore || 0; userPrev = userSnap.data().prevScore || 0; } else { await setDoc(userRef, { username: user, password: pass, bestScore: 0, prevScore: 0 }); }
            currentUsername = user; localStorage.setItem('naruto_user', user); enterGameUI();
        }

        async function saveScore() { if(!currentUsername) return; const finalScore = Math.floor(score); const userRef = doc(db, "players", currentUsername); userPrev = finalScore; if (finalScore > userBest) userBest = finalScore; await setDoc(userRef, { bestScore: userBest, prevScore: userPrev }, { merge: true }); }

        async function fetchLeaderboard() { const q = query(collection(db, "players"), orderBy("bestScore", "desc"), limit(5)); const querySnapshot = await getDocs(q); let html = ""; querySnapshot.forEach((doc) => html += `<div>${doc.id}: ${doc.data().bestScore}</div>`); document.getElementById('high-scores-list').innerHTML = html; }

        function updateStatsUI() { document.getElementById('best-score-ui').innerText = userBest; document.getElementById('prev-score-ui').innerText = userPrev; }

        function createCoin(x, y, lane, isFever = false) { if(!coinTemplate) return; const coin = coinTemplate.clone(); coin.scale.set(CONFIG.coinScale, CONFIG.coinScale, CONFIG.coinScale); const z = getTrackZ(x) + (lane * CONFIG.laneWidth); coin.position.set(x, y, z); coin.userData = { isCollected: false, relLane: lane, spawnX: x, isFeverCoin: isFever }; scene.add(coin); coins.push(coin); }

        function spawnPattern() { if(!coinTemplate || !char || isFeverMode) return; const p = Math.floor(Math.random() * 5); const lane = Math.floor(Math.random() * 3) - 1; switch(p) { case 0: for(let i=0; i<8; i++) createCoin(lastSpawnX - (i*15), 2.8, (i%3)-1); lastSpawnX -= 180; break; case 1: for(let i=0; i<7; i++) createCoin(lastSpawnX-(i*10), 2 + Math.sin((i/6)*Math.PI)*6, 0); lastSpawnX -= 120; break; default: for(let i=0; i<5; i++) createCoin(lastSpawnX - (i*14), 2.8, lane); lastSpawnX -= 110; } }

        function triggerFeverSpawn() { const feverDist = currentSpeed * 220; for(let x = char.position.x - 25; x > char.position.x - feverDist; x -= 10) { for (let l = -1; l <= 1; l++) createCoin(x, 3.5, l, true); } lastSpawnX = char.position.x - feverDist - 30; }

        function resetGame() { isGameOver = false; gameStarted = false; score = 0; scoreTimer = 0; tpTimer = 4.0; isImmune = false; currentMaxAura = 0.8; lastAuraMilestone = 0; if(auraMesh) { auraMesh.visible = false; auraMesh.material.color.setHex(0x00ffff); } currentSpeed = CONFIG.startSpeed; currentLane = 0; triggeredMilestones = []; isFeverMode = false; document.getElementById('fever-ui').style.display = 'none'; document.getElementById('teleport-timer').style.display = 'none'; char.position.set(CONFIG.startPosX, CONFIG.groundY, -53); coins.forEach(c => scene.remove(c)); coins = []; lastSpawnX = char.position.x - 50; document.getElementById('msg').style.display = 'none'; document.getElementById('start-screen').style.display = 'flex'; document.getElementById('ui').style.display = 'none'; if (bgMusic.isPlaying) bgMusic.stop(); updateStatsUI(); fetchLeaderboard(); }

        function onTouch(e) { if (!gameStarted && isReady && currentUsername) { if (e.target.classList.contains('mode-btn')) return; gameStarted = true; document.getElementById('start-screen').style.display = 'none'; document.getElementById('ui').style.display = 'block'; if (!bgMusic.isPlaying) bgMusic.play(); return; } if (isGameOver) return; let sX = e.touches[0].clientX, sY = e.touches[0].clientY, moved = false; window.ontouchmove = (em) => { if (isGameOver || moved) return; let dx = sX - em.touches[0].clientX, dy = sY - em.touches[0].clientY; if (Math.abs(dx) > 25 || Math.abs(dy) > 25) { moved = true; if (Math.abs(dx) > Math.abs(dy)) { if (dx > 25 && currentLane < 1) currentLane++; if (dx < -25 && currentLane > -1) currentLane--; } else { if (dy > 25 && !isJumping) { verticalVelocity = CONFIG.jumpForce; isJumping = true; isRolling = false; char.scale.y = 1.5; } if (dy < -25) { isRolling = true; rollStartTime = Date.now(); char.scale.y = 0.6; if (isJumping) verticalVelocity = -0.9; } } } }; }

        function performTeleport() {
            const forwardJump = 150 + Math.random() * 200;
            const randX = char.position.x - forwardJump;
            const randLane = Math.floor(Math.random() * 3) - 1; 
            const randZ = getTrackZ(randX) + (randLane * CONFIG.laneWidth);
            
            tpRay.set(new THREE.Vector3(randX, 25, randZ), new THREE.Vector3(0, -1, 0));
            const hits = tpRay.intersectObjects(collidableObjects, true);
            const floorY = (hits.length > 0) ? hits[0].point.y : CONFIG.groundY;

            char.position.set(randX, floorY, randZ);
            currentLane = randLane;

            // Apply Progressive Immunity
            isImmune = true;
            auraTimeRemaining = currentMaxAura; 
            if (auraMesh) {
                auraMesh.visible = true;
                // Turn aura Red if it is at the 0.3s limit
                if (currentMaxAura <= MIN_AURA) auraMesh.material.color.setHex(0xff0000);
                else auraMesh.material.color.setHex(0x00ffff);
            }

            char.visible = false;
            setTimeout(() => { if(char) char.visible = true; }, 40);
        }

        function animate() {
            requestAnimationFrame(animate);
            if (!isReady || !gameStarted || isGameOver) { renderer.render(scene, camera); return; }
            const delta = clock.getDelta(); const now = Date.now();
            
            // --- HARD MODE LOGIC ---
            if (gameDifficulty === "hard" && !isFeverMode) {
                // Progression: Reduce aura by 0.1s every 3000 points
                let milestonesPassed = Math.floor(score / 3000);
                if (milestonesPassed > lastAuraMilestone) {
                    lastAuraMilestone = milestonesPassed;
                    currentMaxAura = Math.max(MIN_AURA, 0.8 - (milestonesPassed * 0.1));
                }

                document.getElementById('teleport-timer').style.display = 'block';
                tpTimer -= delta;
                document.getElementById('tp-seconds').innerText = Math.max(0, tpTimer).toFixed(1);

                if (tpTimer <= 0) { 
                    performTeleport(); 
                    tpTimer = 4.0; 
                }
            } else { 
                document.getElementById('teleport-timer').style.display = 'none'; 
            }

            // Aura Visuals/Fading
            if (isImmune) {
                auraTimeRemaining -= delta;
                if (auraMesh) {
                    auraMesh.rotation.y += 0.2;
                    auraMesh.scale.setScalar(1.1 + Math.sin(now * 0.02) * 0.1);
                }
                if (auraTimeRemaining <= 0) {
                    isImmune = false;
                    if (auraMesh) auraMesh.visible = false;
                }
            }

            feverMilestones.forEach(m => { if (score >= m && !triggeredMilestones.includes(m)) { triggeredMilestones.push(m); isFeverMode = true; feverEndTime = now + 4000; document.getElementById('fever-ui').style.display = 'flex'; triggerFeverSpawn(); } });
            if (isFeverMode && now >= feverEndTime) { isFeverMode = false; document.getElementById('fever-ui').style.display = 'none'; }
            
            if (lastSpawnX > char.position.x - 450) spawnPattern();
            if (char.position.x < CONFIG.WORLD_END_X) { const shift = CONFIG.startPosX - char.position.x; char.position.x = CONFIG.startPosX; lastSpawnX = CONFIG.startPosX - 50; coins.forEach(c => c.position.x += shift); }

            const mult = (gameDifficulty === "hard") ? 2 : 1;
            if (isRolling && now - rollStartTime > CONFIG.rollDuration) { isRolling = false; char.scale.y = 1.5; }
            currentSpeed = Math.min(CONFIG.startSpeed + (score * CONFIG.speedFactor), CONFIG.maxSpeed);
            scoreTimer += delta; if (scoreTimer >= 1.0) { score += (10 * mult); scoreTimer = 0; }
            char.position.x -= currentSpeed;
            document.getElementById('score').innerText = Math.floor(score);
            char.position.z = THREE.MathUtils.lerp(char.position.z, getTrackZ(char.position.x) + (currentLane * CONFIG.laneWidth), CONFIG.laneSnapSpeed);
            
            downRay.set(new THREE.Vector3(char.position.x, char.position.y + 2, char.position.z), new THREE.Vector3(0, -1, 0));
            const downHits = downRay.intersectObjects(collidableObjects, true);
            let floorY = (downHits.length > 0 && downHits[0].point.y > 0.5) ? downHits[0].point.y : CONFIG.groundY;
            char.position.y += verticalVelocity;
            if (char.position.y > floorY) verticalVelocity -= (isRolling ? CONFIG.rollGravity : CONFIG.gravity);
            else { char.position.y = floorY; verticalVelocity = 0; isJumping = false; }

            for (let i = coins.length - 1; i >= 0; i--) {
                const c = coins[i];
                if (!c.userData.isCollected) {
                    c.rotation.y += 0.1;
                    if (char.position.distanceTo(c.position) < 4.5) { c.userData.isCollected = true; score += (CONFIG.coinValue * mult); if (coinSound.isPlaying) coinSound.stop(); coinSound.play(); }
                    if (c.position.x > char.position.x + 100) { scene.remove(c); coins.splice(i, 1); }
                } else { c.scale.multiplyScalar(1.2); c.position.y += 0.5; if (c.scale.x > 25) { scene.remove(c); coins.splice(i, 1); } }
            }
            
            frontRay.set(new THREE.Vector3(char.position.x, char.position.y + (isRolling?0.5:1.2), char.position.z), new THREE.Vector3(-1, 0, 0));
            if (!isImmune && frontRay.intersectObjects(collidableObjects, true).some(h => h.distance < 1.0)) gameOver();

            camera.position.set(char.position.x + 22, char.position.y + 8, THREE.MathUtils.lerp(camera.position.z, char.position.z, 0.2));
            camera.lookAt(char.position.x - 30, char.position.y + 2, char.position.z);
            if (mixer) mixer.update(delta * (currentSpeed * 1.5));
            renderer.render(scene, camera);
        }

        async function gameOver() { isGameOver = true; document.getElementById('msg').style.display = 'block'; document.getElementById('fever-ui').style.display = 'none'; document.getElementById('teleport-timer').style.display = 'none'; if (bgMusic.isPlaying) bgMusic.stop(); await saveScore(); setTimeout(resetGame, 2000); }
    </script>
</body>
</html>

