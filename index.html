<!DOCTYPE html>
<html>
<head>
    <title>Naruto Runner - Ultra Optimized</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; touch-action: none; font-family: sans-serif; }
        #loader-screen { position: fixed; inset: 0; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; color: white; }
        #load-bar-bg { width: 200px; height: 6px; background: #222; margin-top: 10px; border-radius: 3px; }
        #load-bar-fill { width: 0%; height: 100%; background: #ff4444; }
        #login-screen, #start-screen { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 200; color: white; text-align: center; }
        #ui { position: fixed; top: 15px; left: 15px; color: #fff; font-size: 24px; font-weight: bold; z-index: 10; display: none; }
        #fever-ui { position: fixed; top: 50px; left: 15px; color: #ff0; font-size: 20px; z-index: 10; display: none; align-items: center; }
        #msg { position: fixed; top: 40%; width: 100%; text-align: center; color: #ff4444; font-size: 45px; font-weight: bold; display: none; z-index: 100; }
        input { padding: 10px; margin: 5px; border-radius: 4px; width: 180px; }
        button { padding: 10px 20px; background: #ff4444; color: #fff; border: none; font-weight: bold; border-radius: 4px; }
    </style>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js"
        }
    }
    </script>
</head>
<body>

    <div id="loader-screen">
        <div style="font-size: 14px; letter-spacing: 3px;">SHINOBI LOADING</div>
        <div id="load-bar-bg"><div id="load-bar-fill"></div></div>
    </div>

    <div id="login-screen">
        <h2>NARUTO RUNNER</h2>
        <input type="text" id="username" placeholder="Username">
        <input type="password" id="pass" placeholder="Password">
        <button id="login-btn">START MISSION</button>
    </div>

    <div id="start-screen">
        <div style="margin-bottom:15px">BEST: <span id="best-score-ui">0</span></div>
        <h1 style="font-size: 32px;">TAP TO RUN</h1>
    </div>

    <div id="ui">SCORE: <span id="score">0</span></div>
    <div id="fever-ui">GOLD RUSH ðŸ”¥</div>
    <div id="msg">WASTED</div>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { initializeApp } from "firebase/app";
        import { getFirestore, collection, query, orderBy, limit, getDocs, doc, setDoc, getDoc } from "firebase/firestore";

        // --- Firebase (Kept Same) ---
        const firebaseConfig = { apiKey: "AIzaSyBUUd2oA6HMEpa7TqOwOiiUCKSugsLOrUY", authDomain: "game-e2f9a.firebaseapp.com", projectId: "game-e2f9a", storageBucket: "game-e2f9a.firebasestorage.app", messagingSenderId: "997350610258", appId: "1:997350610258:web:495b64bd803b12e3b1968b" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let scene, camera, renderer, char, mixer, clock = new THREE.Clock();
        let isReady = false, gameStarted = false, isGameOver = false, score = 0;
        let coins = [], coinTemplate = null, collidableObjects = [];
        let currentLane = 0, currentSpeed = 1.0, verticalVel = 0, isJumping = false, isRolling = false;
        let currentUsername = "", lastSpawnX = -150, feverMode = false, feverEnd = 0;

        const CONFIG = {
            LANE_WIDTH: 4.8, MAX_SPEED: 8.0, 
            GRAVITY: 0.03, JUMP: 0.52, 
            RENDER_DIST: 250, // Strict rendering distance for no lag
            FAR_CLIP: 450
        };

        const railPoints = [{x:-131, z:-53}, {x:-406, z:-53.4}, {x:-506, z:-54.1}, {x:-661, z:-55.4}, {x:-861, z:-57.5}];

        // --- ASSET LOADER ---
        const manager = new THREE.LoadingManager();
        manager.onProgress = (u, l, t) => document.getElementById('load-bar-fill').style.width = (l/t*100)+'%';
        manager.onLoad = () => {
            document.getElementById('loader-screen').style.display='none';
            isReady = true; checkUser(); animate();
        };

        const loader = new GLTFLoader(manager);

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb);
            camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 0.5, CONFIG.FAR_CLIP);
            
            renderer = new THREE.WebGLRenderer({ antialias: false, powerPreference: "high-performance" });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(1); // Performance boost: no retina scaling
            document.body.appendChild(renderer.domElement);

            scene.add(new THREE.AmbientLight(0xffffff, 3.0));
            const sun = new THREE.DirectionalLight(0xffffff, 1.0);
            sun.position.set(5, 20, 5);
            scene.add(sun);

            // Load Map
            loader.load('subway_surfers_maps.glb', (g) => {
                scene.add(g.scene);
                g.scene.traverse(c => {
                    if(c.isMesh) {
                        collidableObjects.push(c);
                        c.matrixAutoUpdate = false; // Freeze map matrices
                        c.updateMatrix();
                    }
                });
            });

            // Load Player
            loader.load('naruto_uzumaki_running_animation.glb', (g) => {
                char = g.scene; char.scale.set(1.5,1.5,1.5);
                char.position.set(-135, 0.2, -53);
                scene.add(char);
                mixer = new THREE.AnimationMixer(char);
                mixer.clipAction(g.animations[0]).play();
            });

            // Load Coin
            loader.load('subway_surfers_coin.glb', (g) => { coinTemplate = g.scene; });

            window.addEventListener('touchstart', handleTouch);
            document.getElementById('login-btn').onclick = login;
        }

        // --- LOGIC ---
        function getTrackZ(x) {
            for (let i = 0; i < railPoints.length - 1; i++) {
                let p1 = railPoints[i], p2 = railPoints[i+1];
                if (x <= p1.x && x >= p2.x) return p1.z + ((x - p1.x) / (p2.x - p1.x)) * (p2.z - p1.z);
            }
            return railPoints[railPoints.length-1].z;
        }

        function spawnPattern() {
            if(!coinTemplate || feverMode) return;
            const lane = Math.floor(Math.random()*3)-1;
            for(let i=0; i<5; i++) {
                const c = coinTemplate.clone();
                const x = lastSpawnX - (i*15);
                c.position.set(x, 2.8, getTrackZ(x) + (lane * CONFIG.LANE_WIDTH));
                c.scale.set(8,8,8);
                c.matrixAutoUpdate = false; c.updateMatrix();
                scene.add(c); coins.push(c);
            }
            lastSpawnX -= 120;
        }

        function animate() {
            requestAnimationFrame(animate);
            if(!isReady || !gameStarted || isGameOver) { renderer.render(scene, camera); return; }

            const dt = clock.getDelta();
            const now = Date.now();

            // Optimization: Fever Check
            if(score > 500 && !feverMode && Math.random() < 0.001) {
                feverMode = true; feverEnd = now + 4000;
                document.getElementById('fever-ui').style.display = 'flex';
            }
            if(feverMode && now > feverEnd) { feverMode = false; document.getElementById('fever-ui').style.display = 'none'; }

            // Movement
            currentSpeed = Math.min(1.0 + (score * 0.00005), CONFIG.MAX_SPEED);
            score += dt * 12;
            char.position.x -= currentSpeed;
            document.getElementById('score').innerText = Math.floor(score);

            // Lane & Physics
            const tZ = getTrackZ(char.position.x) + (currentLane * CONFIG.LANE_WIDTH);
            char.position.z = THREE.MathUtils.lerp(char.position.z, tZ, 0.15);

            char.position.y += verticalVel;
            if(char.position.y > 0.2) verticalVel -= CONFIG.GRAVITY;
            else { char.position.y = 0.2; verticalVel = 0; isJumping = false; }

            // Collision & Performance Culling
            for(let i=coins.length-1; i>=0; i--) {
                const c = coins[i];
                const dx = c.position.x - char.position.x;
                
                // Hide coins far away (GPU Boost)
                c.visible = Math.abs(dx) < CONFIG.RENDER_DIST;

                if(Math.abs(dx) < 3 && Math.abs(c.position.z - char.position.z) < 2) {
                    scene.remove(c); coins.splice(i, 1); score += 50;
                } else if(dx > 50) {
                    scene.remove(c); coins.splice(i, 1);
                }
            }

            if(lastSpawnX > char.position.x - 400) spawnPattern();

            // World Loop
            if(char.position.x < -850) {
                const off = -135 - char.position.x;
                char.position.x = -135; lastSpawnX = -185;
                coins.forEach(c => { c.position.x += off; c.updateMatrix(); });
            }

            camera.position.set(char.position.x + 20, char.position.y + 8, char.position.z);
            camera.lookAt(char.position.x - 20, 2, char.position.z);

            if(mixer) mixer.update(dt * (currentSpeed * 1.2));
            renderer.render(scene, camera);
        }

        // --- HANDLERS ---
        async function checkUser() {
            const saved = localStorage.getItem('naruto_user');
            if(saved) {
                currentUsername = saved;
                const snap = await getDoc(doc(db, "players", saved));
                document.getElementById('best-score-ui').innerText = snap.exists() ? snap.data().bestScore : 0;
                document.getElementById('start-screen').style.display = 'flex';
            } else {
                document.getElementById('login-screen').style.display = 'flex';
            }
        }

        async function login() {
            const u = document.getElementById('username').value;
            if(!u) return;
            currentUsername = u;
            localStorage.setItem('naruto_user', u);
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('start-screen').style.display = 'flex';
        }

        let sY, sX;
        function handleTouch(e) {
            if(!gameStarted) { gameStarted = true; document.getElementById('start-screen').style.display='none'; document.getElementById('ui').style.display='block'; return; }
            sX = e.touches[0].clientX; sY = e.touches[0].clientY;
            window.ontouchmove = (em) => {
                let dx = sX - em.touches[0].clientX, dy = sY - em.touches[0].clientY;
                if(Math.abs(dx) > 20) { if(dx > 20 && currentLane < 1) currentLane++; if(dx < -20 && currentLane > -1) currentLane--; window.ontouchmove=null; }
                else if(dy > 20 && !isJumping) { verticalVel = CONFIG.JUMP; isJumping = true; window.ontouchmove=null; }
            }
        }

        init();
    </script>
</body>
</html>

