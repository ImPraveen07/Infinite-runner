<!DOCTYPE html>
<html>
<head>
    <title>Naruto Runner - Fixed Asset Loading</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; overflow: hidden; background-color: #87ceeb; touch-action: none; font-family: 'Arial', sans-serif; }
        #login-screen, #start-screen {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 200; color: white; text-align: center;
        }
        #start-screen { background: rgba(0,0,0,0.4); display: none; }
        #ui { position: fixed; top: 20px; left: 20px; color: white; text-shadow: 2px 2px #000; z-index: 10; font-size: 28px; font-weight: bold; display: none; }
        #fever-ui { position: fixed; top: 70px; left: 20px; color: #ffff00; font-size: 24px; font-weight: bold; display: none; text-shadow: 2px 2px #000; z-index: 10; align-items: center; gap: 10px; }
        #msg { position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%); color: #ff4444; font-size: 50px; font-weight: bold; display: none; text-shadow: 3px 3px #000; z-index: 100; text-align: center; }
        input { padding: 12px; margin: 10px; border-radius: 5px; border: none; font-size: 16px; width: 200px; }
        button { padding: 12px 25px; background: #ff4444; color: white; border: none; font-size: 18px; font-weight: bold; cursor: pointer; border-radius: 5px; }
        #loading-msg { font-size: 14px; color: #aaa; margin-top: 10px; }
    </style>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js"
        }
    }
    </script>
</head>
<body>

    <div id="login-screen">
        <h1>NARUTO RUNNER</h1>
        <input type="text" id="username" placeholder="Username">
        <input type="password" id="pass" placeholder="Password">
        <button id="login-btn">ENTER GAME</button>
        <div id="loading-msg">Waiting for assets...</div>
    </div>

    <div id="start-screen">
        <h2 style="font-size: 40px;">TAP TO START</h2>
        <p>User: <span id="current-user-display"></span></p>
    </div>

    <div id="ui">SCORE: <span id="score">0</span></div>
    <div id="fever-ui">GOLD RUSH âœ¨</div>
    <div id="msg">WASTED</div>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { initializeApp } from "firebase/app";
        import { getFirestore, collection, query, orderBy, limit, getDocs, doc, setDoc, getDoc } from "firebase/firestore";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBUUd2oA6HMEpa7TqOwOiiUCKSugsLOrUY",
            authDomain: "game-e2f9a.firebaseapp.com",
            projectId: "game-e2f9a",
            storageBucket: "game-e2f9a.firebasestorage.app",
            messagingSenderId: "997350610258",
            appId: "1:997350610258:web:495b64bd803b12e3b1968b"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Asset URLs (Publicly hosted versions)
        const ASSETS = {
            map: 'https://raw.githubusercontent.com/mrdoob/three.js/dev/examples/models/gltf/RobotExpressive/RobotExpressive.glb', // Placeholder Map
            char: 'https://raw.githubusercontent.com/mrdoob/three.js/dev/examples/models/gltf/Soldier.glb', // Placeholder Char
            coin: 'https://raw.githubusercontent.com/mrdoob/three.js/dev/examples/models/gltf/DamagedHelmet/glTF/DamagedHelmet.gltf' // Placeholder Coin
        };

        let scene, camera, renderer, char, mixer, clock = new THREE.Clock();
        let isReady = false, isGameOver = false, gameStarted = false, score = 0;
        let currentUsername = "";
        let coins = [], coinTemplate = null, collidableObjects = [];
        let lastSpawnX = -150, scoreTimer = 0;
        let isFeverMode = false, feverEndTime = 0, isFadingFever = false;

        const CONFIG = { 
            laneWidth: 4.8, startSpeed: 1.0, maxSpeed: 8.0, speedFactor: 0.00007, 
            startPosX: -135, groundY: 0.2, gravity: 0.03, coinScale: 2.0 
        };

        // --- LOGIN LOGIC ---
        async function login() {
            const user = document.getElementById('username').value.trim();
            const pass = document.getElementById('pass').value;
            if (!user) return alert("Enter Username");
            if (!isReady) return alert("Game is still loading assets...");

            const userRef = doc(db, "players", user);
            const userSnap = await getDoc(userRef);

            if (userSnap.exists()) {
                if (userSnap.data().password !== pass) {
                    alert("Wrong password for this user!");
                    return; 
                }
            } else {
                await setDoc(userRef, { username: user, password: pass, bestScore: 0 });
            }

            currentUsername = user;
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('start-screen').style.display = 'flex';
            document.getElementById('current-user-display').innerText = user;
        }

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb);
            camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 5000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            scene.add(new THREE.AmbientLight(0xffffff, 2));
            const sun = new THREE.DirectionalLight(0xffffff, 1); sun.position.set(10, 50, 10); scene.add(sun);

            const loader = new GLTFLoader();
            // Load Map -> Then Char -> Then Coin
            loader.load(ASSETS.map, (gltf) => {
                scene.add(gltf.scene);
                gltf.scene.traverse(c => { if(c.isMesh) collidableObjects.push(c); });
                
                loader.load(ASSETS.char, (gChar) => {
                    char = gChar.scene; char.scale.set(1.5, 1.5, 1.5);
                    char.position.set(CONFIG.startPosX, CONFIG.groundY, -53);
                    char.rotation.set(0, -Math.PI / 2, 0);
                    scene.add(char);
                    mixer = new THREE.AnimationMixer(char);
                    mixer.clipAction(gChar.animations[0]).play();

                    loader.load(ASSETS.coin, (gCoin) => {
                        coinTemplate = gCoin.scene;
                        isReady = true;
                        document.getElementById('loading-msg').innerText = "Assets Loaded! Login to play.";
                        animate();
                    });
                });
            });

            document.getElementById('login-btn').onclick = login;
            window.addEventListener('touchstart', () => {
                if (isReady && !gameStarted && currentUsername) {
                    gameStarted = true;
                    document.getElementById('start-screen').style.display = 'none';
                    document.getElementById('ui').style.display = 'block';
                }
            });
        }

        function createCoin(x, y, lane, isFever = false) {
            const coin = coinTemplate.clone();
            coin.scale.set(CONFIG.coinScale, CONFIG.coinScale, CONFIG.coinScale);
            coin.position.set(x, y, -53 + (lane * CONFIG.laneWidth));
            coin.userData = { isFeverCoin: isFever, blinkTimer: 0 };
            scene.add(coin); coins.push(coin);
        }

        function animate() {
            requestAnimationFrame(animate);
            if (!gameStarted || isGameOver) {
                renderer.render(scene, camera);
                return;
            }

            const delta = clock.getDelta();
            const now = Date.now();

            // Gold Rush Trigger at 500 Score
            if (score >= 500 && !isFeverMode && !isFadingFever) {
                isFeverMode = true;
                feverEndTime = now + 3000;
                document.getElementById('fever-ui').style.display = 'flex';
                for(let i=0; i<30; i++) createCoin(char.position.x - (i*15), 5, (i%3)-1, true);
            }

            // Sync Vanish Logic
            if (isFeverMode && now >= feverEndTime) {
                isFeverMode = false;
                isFadingFever = true;
                document.getElementById('fever-ui').style.display = 'none';
            }

            // Movement & Gameplay
            char.position.x -= CONFIG.startSpeed;
            score += 1;
            document.getElementById('score').innerText = score;

            // Fever Fade Logic
            for (let i = coins.length - 1; i >= 0; i--) {
                const c = coins[i];
                if (isFadingFever && c.userData.isFeverCoin) {
                    c.userData.blinkTimer += delta * 15;
                    c.visible = Math.floor(c.userData.blinkTimer) % 2 === 0;
                    c.scale.multiplyScalar(0.9);
                    if (c.scale.x < 0.1) { scene.remove(c); coins.splice(i, 1); }
                }
            }

            camera.position.set(char.position.x + 25, 10, char.position.z);
            camera.lookAt(char.position);
            if (mixer) mixer.update(delta);
            renderer.render(scene, camera);
        }

        init();
    </script>
</body>
</html>

